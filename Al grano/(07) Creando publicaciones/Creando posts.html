<!DOCTYPE html>
<!-- saved from url=(0053)http://es.discovermeteor.com/chapters/creating-posts/ -->
<html class="no-js wf-klavikaweb-n3-active wf-klavikaweb-n6-active wf-sourcesanspro-n4-active wf-sourcesanspro-n7-active wf-sourcesanspro-i7-active wf-sourcesanspro-i4-active wf-sourcesanspro-n3-active wf-sourcesanspro-i3-active wf-sourcecodepro-n7-active wf-sourcecodepro-n4-active wf-active" lang="es"><!-- <![endif] --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <!-- Set the viewport width to device width for mobile -->
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Creando publicaciones - Descubriendo Meteor</title>
    <!-- Included CSS Files -->
    <link href="./Creando posts_files/screen.css" rel="stylesheet">
    <link href="./Creando posts_files/print.css" media="print" rel="stylesheet">
    <!-- %link{:href => "http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,700,400italic", :rel => "stylesheet"} -->
    <!-- %link{:href => "http://fonts.googleapis.com/css?family=Source+Code+Pro:400,700", :rel => "stylesheet"} -->
    <link href="http://es.discovermeteor.com/images/favicon.ico" rel="shortcut icon">
    <script async="" src="./Creando posts_files/analytics.js.descarga"></script><script src="./Creando posts_files/jquery.min.js.descarga"></script>
    <script src="./Creando posts_files/rcr2ohz.js.descarga"></script>
    <style type="text/css">.tk-klavika-web{font-family:"klavika-web",sans-serif;}.tk-source-sans-pro{font-family:"source-sans-pro",sans-serif;}.tk-source-code-pro{font-family:"source-code-pro",sans-serif;}</style><style type="text/css">@font-face{font-family:klavika-web;src:url(https://use.typekit.net/af/5401fe/00000000000000003b9acdf2/27/l?subset_id=2&fvd=n3&v=3) format("woff2"),url(https://use.typekit.net/af/5401fe/00000000000000003b9acdf2/27/d?subset_id=2&fvd=n3&v=3) format("woff"),url(https://use.typekit.net/af/5401fe/00000000000000003b9acdf2/27/a?subset_id=2&fvd=n3&v=3) format("opentype");font-weight:300;font-style:normal;}@font-face{font-family:klavika-web;src:url(https://use.typekit.net/af/835e90/00000000000000003b9acdf6/27/l?subset_id=2&fvd=n6&v=3) format("woff2"),url(https://use.typekit.net/af/835e90/00000000000000003b9acdf6/27/d?subset_id=2&fvd=n6&v=3) format("woff"),url(https://use.typekit.net/af/835e90/00000000000000003b9acdf6/27/a?subset_id=2&fvd=n6&v=3) format("opentype");font-weight:600;font-style:normal;}@font-face{font-family:source-sans-pro;src:url(https://use.typekit.net/af/b0088d/00000000000000003b9acb59/27/l?subset_id=2&fvd=n4&v=3) format("woff2"),url(https://use.typekit.net/af/b0088d/00000000000000003b9acb59/27/d?subset_id=2&fvd=n4&v=3) format("woff"),url(https://use.typekit.net/af/b0088d/00000000000000003b9acb59/27/a?subset_id=2&fvd=n4&v=3) format("opentype");font-weight:400;font-style:normal;}@font-face{font-family:source-sans-pro;src:url(https://use.typekit.net/af/c55ca5/00000000000000003b9acb5c/27/l?subset_id=2&fvd=n7&v=3) format("woff2"),url(https://use.typekit.net/af/c55ca5/00000000000000003b9acb5c/27/d?subset_id=2&fvd=n7&v=3) format("woff"),url(https://use.typekit.net/af/c55ca5/00000000000000003b9acb5c/27/a?subset_id=2&fvd=n7&v=3) format("opentype");font-weight:700;font-style:normal;}@font-face{font-family:source-sans-pro;src:url(https://use.typekit.net/af/7e0c18/00000000000000003b9acb5d/27/l?subset_id=2&fvd=i7&v=3) format("woff2"),url(https://use.typekit.net/af/7e0c18/00000000000000003b9acb5d/27/d?subset_id=2&fvd=i7&v=3) format("woff"),url(https://use.typekit.net/af/7e0c18/00000000000000003b9acb5d/27/a?subset_id=2&fvd=i7&v=3) format("opentype");font-weight:700;font-style:italic;}@font-face{font-family:source-sans-pro;src:url(https://use.typekit.net/af/c42064/00000000000000003b9acb58/27/l?subset_id=2&fvd=i4&v=3) format("woff2"),url(https://use.typekit.net/af/c42064/00000000000000003b9acb58/27/d?subset_id=2&fvd=i4&v=3) format("woff"),url(https://use.typekit.net/af/c42064/00000000000000003b9acb58/27/a?subset_id=2&fvd=i4&v=3) format("opentype");font-weight:400;font-style:italic;}@font-face{font-family:source-sans-pro;src:url(https://use.typekit.net/af/b35fa2/00000000000000003b9acb56/27/l?subset_id=2&fvd=n3&v=3) format("woff2"),url(https://use.typekit.net/af/b35fa2/00000000000000003b9acb56/27/d?subset_id=2&fvd=n3&v=3) format("woff"),url(https://use.typekit.net/af/b35fa2/00000000000000003b9acb56/27/a?subset_id=2&fvd=n3&v=3) format("opentype");font-weight:300;font-style:normal;}@font-face{font-family:source-sans-pro;src:url(https://use.typekit.net/af/a6c785/00000000000000003b9acb57/27/l?subset_id=2&fvd=i3&v=3) format("woff2"),url(https://use.typekit.net/af/a6c785/00000000000000003b9acb57/27/d?subset_id=2&fvd=i3&v=3) format("woff"),url(https://use.typekit.net/af/a6c785/00000000000000003b9acb57/27/a?subset_id=2&fvd=i3&v=3) format("opentype");font-weight:300;font-style:italic;}@font-face{font-family:source-code-pro;src:url(https://use.typekit.net/af/b8b49b/0000000000000000000179d5/27/l?subset_id=2&fvd=n7&v=3) format("woff2"),url(https://use.typekit.net/af/b8b49b/0000000000000000000179d5/27/d?subset_id=2&fvd=n7&v=3) format("woff"),url(https://use.typekit.net/af/b8b49b/0000000000000000000179d5/27/a?subset_id=2&fvd=n7&v=3) format("opentype");font-weight:700;font-style:normal;}@font-face{font-family:source-code-pro;src:url(https://use.typekit.net/af/953e9e/0000000000000000000179cf/27/l?subset_id=2&fvd=n4&v=3) format("woff2"),url(https://use.typekit.net/af/953e9e/0000000000000000000179cf/27/d?subset_id=2&fvd=n4&v=3) format("woff"),url(https://use.typekit.net/af/953e9e/0000000000000000000179cf/27/a?subset_id=2&fvd=n4&v=3) format("opentype");font-weight:400;font-style:normal;}</style><script>
      try{Typekit.load();}catch(e){}
    </script>
  <style type="text/css">
:root .adsbox
{ display: none !important; }</style><script type="text/javascript" async="" src="./Creando posts_files/embed.js.descarga"></script><script async="" type="text/javascript" src="./Creando posts_files/count.js.descarga"></script><style type="text/css">
:root *[np65syh][hidden] { display: none !important; }</style><link rel="preload" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.2d848eddee1b8c12749b72a04b2b33dc.css"><link rel="preload" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.845ead53749f15d0bd8a5ee344c8f06e.js"><link rel="preload" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.8241ae5fc761eb94635acdc63f5fd29f.js"><link rel="preload" as="script" href="https://disqus.com/next/config.js"><script src="./Creando posts_files/count-data.js.descarga"></script><script src="./Creando posts_files/alfie.f51946af45e0b561c60f768335c9eb79.js.descarga" async="" charset="UTF-8"></script></head>
  <body style="zoom: 1;" cz-shortcut-listen="true">
    <header>
      <h1>
        <a href="http://es.discovermeteor.com/">
          <span>Descubriendo</span>
          <strong>Meteor</strong>
        </a>
      </h1>
    </header>
    <div class="main">
      <div class="row">
        <div class="toc sidebar">
          <a class="sidebar-toggle" href="javascript:void(0)">Toggle Table of Contents</a>
          <div class="sidebar-inner">
            <ul>
              <li>
                <span class="number">
                  1
                </span>
                <a href="http://es.discovermeteor.com/chapters/introduction/">
                  Introducción
                </a>
              </li>
              <li>
                <span class="number">
                  2
                </span>
                <a href="http://es.discovermeteor.com/chapters/getting-started/">
                  Empezando
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  2.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/deploying/">
                  Despliegue
                </a>
              </li>
              <li>
                <span class="number">
                  3
                </span>
                <a href="http://es.discovermeteor.com/chapters/templates/">
                  Plantillas
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  3.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/github/">
                  Usando Git y GitHub
                </a>
              </li>
              <li>
                <span class="number">
                  4
                </span>
                <a href="http://es.discovermeteor.com/chapters/collections/">
                  Colecciones
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  4.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/publications-and-subscriptions/">
                  Publicaciones y suscripciones
                </a>
              </li>
              <li>
                <span class="number">
                  5
                </span>
                <a href="http://es.discovermeteor.com/chapters/routing/">
                  Enrutando
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  5.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/the-session/">
                  La sesión
                </a>
              </li>
              <li>
                <span class="number">
                  6
                </span>
                <a href="http://es.discovermeteor.com/chapters/adding-users/">
                  Añadiendo usuarios
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  6.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/reactivity/">
                  Reactividad
                </a>
              </li>
              <li class="active">
                <span class="number">
                  7
                </span>
                <a href="http://es.discovermeteor.com/chapters/creating-posts/">
                  Creando publicaciones
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  7.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/latency-compensation/">
                  Compensación de la latencia
                </a>
              </li>
              <li>
                <span class="number">
                  8
                </span>
                <a href="http://es.discovermeteor.com/chapters/editing-posts/">
                  Editando publicaciones
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  8.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/allow-and-deny/">
                  Permitir y Denegar
                </a>
              </li>
              <li>
                <span class="number">
                  9
                </span>
                <a href="http://es.discovermeteor.com/chapters/errors/">
                  Errores
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  9.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/creating-a-meteor-package/">
                  Creando un paquete Meteor
                </a>
              </li>
              <li>
                <span class="number">
                  10
                </span>
                <a href="http://es.discovermeteor.com/chapters/comments/">
                  Comentarios
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  10.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/denormalization/">
                  Denormalización
                </a>
              </li>
              <li>
                <span class="number">
                  11
                </span>
                <a href="http://es.discovermeteor.com/chapters/notifications/">
                  Notificaciones
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  11.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/advanced-reactivity/">
                  Reactividad avanzada
                </a>
              </li>
              <li>
                <span class="number">
                  12
                </span>
                <a href="http://es.discovermeteor.com/chapters/pagination/">
                  Paginación
                </a>
              </li>
              <li>
                <span class="number">
                  13
                </span>
                <a href="http://es.discovermeteor.com/chapters/voting/">
                  Votos
                </a>
              </li>
              <li class="sidebar-chapter">
                <span class="number">
                  13.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/advanced-publications/">
                  Publicaciones avanzadas
                </a>
              </li>
              <li>
                <span class="number">
                  14
                </span>
                <a href="http://es.discovermeteor.com/chapters/animations/">
                  Animaciones
                </a>
              </li>
              <li>
                <span class="number">
                  14.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/going-further/">
                  Ir más lejos
                </a>
              </li>
              <li>
                <span class="number">
                  14.5
                </span>
                <a href="http://es.discovermeteor.com/chapters/meteor-vocabulary/">
                  Vocabulario
                </a>
              </li>
              <li>
                <span class="number">
                  99
                </span>
                <a href="http://es.discovermeteor.com/chapters/changelog/">
                  Changelog
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="vocabulary sidebar">
          <a class="sidebar-toggle" href="http://es.discovermeteor.com/chapters/creating-posts/#">Toggle Vocabulary</a>
          <div class="sidebar-inner">
            <div class="sidebar-content">
				<h3>Vocabulary</h3>
				<h4>Cliente</h4>

				<p style="display: none;">Cuando hablamos del Cliente, nos referimos al código que se ejecuta en el navegador de los usuarios, ya sea uno tradicional, como Firefox o Safari, o algo tan complejo como un UIWebView en una aplicación nativa para el iPhone.</p>

				<h4>Colección</h4>

				<p style="display: none;">Una colección es el almacén de datos que se sincroniza automáticamente entre el cliente y el servidor. Las colecciones tienen un nombre (como <code>publicaciones</code>), y por lo general existen tanto en el cliente como en el servidor. Si bien se comportan de forma distinta, tienen una API común basada en la API de Mongo.</p>

				<h4>Computación</h4>

				<p style="display: none;">Una computación es un bloque de código que se ejecuta cada vez que cambia una de las fuentes de datos reactivos de las que depende. Si tienes una fuente reactiva (por ejemplo, una variable de sesión) y quieres responder reactivamente a ella, tendrás que crear una computación.</p>

				<h4>Cursor</h4>

				<p style="display: none;">Un cursor es el resultado de ejecutar una consulta en una colección Mongo. En el lado del cliente, un cursor no es tan sólo un conjunto de resultados, sino que es un objeto <em>reactivo</em> desde el que se puede observar (con <code>observe()</code>) los cambios (añadir, eliminar o actualizar) en la colección correspondiente.</p>

				<h4>DDP</h4>

				<p style="display: none;">El DDP es el Protocolo de Datos Distribuidos que utiliza Meteor para sincronizar colecciones y efectuar llamadas a métodos. DDP pretende ser un protocolo genérico, que toma el relevo a HTTP para aplicaciones en tiempo real con gran carga de datos.</p>

				<h4>Deps</h4>

				<p style="display: none;">Deps es el sistema reactivo de Meteor. Deps se utiliza entre bastidores para sincronizar automáticamente el  HTML con el modelo de datos subyacente.</p>

				<h4>Documento</h4>

				<p style="display: none;">Mongo es un almacén de datos basado en documentos y a los objetos que salen de las colecciones se les llama “documentos”. Son objetos JavaScript sin formato (aunque no pueden contener funciones) con una única propiedad especial, el ’_id’, que Meteor utiliza para realizar un seguimiento de sus propiedades en el DDP.</p>

				<h4>Ayudantes</h4>

				<p style="display: none;">Cuando una plantilla necesita mostrar cosas más complejas que una simple propiedad de un documento, ésta puede hacer uso de su ayudante, una función que se utiliza para procesar los datos que se muestran en ella.</p>

				<h4>Compensación de la latencia</h4>

				<p style="display: none;">Es una técnica que permite simular llamadas a métodos en el cliente para evitar retrasos mientras se espera la respuesta del servidor.</p>

				<h4>Meteor Development Group (MDG)</h4>

				<p style="display: none;">La empresa que desarrolla Meteor.</p>

				<h4>Método</h4>

				<p style="display: none;">Un método en Meteor es una llamada desde el cliente, a un procedimiento remoto en el servidor, con un poco de lógica añadida que permite realizar un seguimiento de los cambios en los datos además de compensar la latencia de la llamada.</p>

				<h4>MiniMongo</h4>

				<p style="display: none;">La colección del lado del cliente es un almacén de datos en memoria que ofrece una API tipo Mongo. La librería que se utiliza se llama “MiniMongo”, para indicar que es una versión más pequeña de Mongo que se ejecuta por completo en la memoria del navegador.</p>

				<h4>Paquete</h4>

				<p style="display: none;">Un paquete Meteor puede ser: código JavaScript que se ejecuta en el servidor, código JavaScript que se ejecuta en el cliente, instrucciones para procesar recursos (como SASS a CSS), o recursos que deben ser  procesados​​. <br> Un paquete es como una librería con superpoderes. Meteor incluye una gran cantidad de paquetes (<code>meteor list</code>). También existe <a href="http://atmosphere.meteor.com/">Atmosphere</a>, que es una colección de paquetes de terceros mantenida por la comunidad (<code>mrt add ...</code>).</p>

				<h4>Publicación</h4>

				<p style="display: none;">Una publicación es un conjunto de datos con nombre que se personaliza para cada usuario que se suscribe a ella. Se configuran en el servidor.</p>

				<h4>Servidor</h4>

				<p style="display: none;">El servidor Meteor es un servidor HTTP y DDP ejecutados vía Node.js. Se compone de todas las librerías y del código JavaScript del lado del servidor. Cuando se inicia el servidor, se conecta a una base de datos Mongo (que configura por si mismo en el primer arranque).</p>

				<h4>Sesión</h4>

				<p style="display: none;">La sesión en Meteor es una fuente de datos reactiva que usa tu aplicación para hacer un seguimiento del estado del usuario.</p>

				<h4>Suscripción</h4>

				<p style="display: none;">Una suscripción es una conexión a una publicación desde un cliente específico. La suscripción es el código que ejecuta el navegador y que utiliza para comunicarse con una publicación del servidor y que, además, mantiene los datos sincronizados.</p>
              
				<h4>Plantilla</h4>

				<p style="display: none;">Una plantilla es una forma de generar código HTML desde JavaScript. Por defecto, Meteor sólo soporta el sistema Spacebars, pero hay planes para incluir más.</p>

				<h4>Contexto de datos de una plantilla</h4>

				<p style="display: none;">Cuando se muestra un plantilla, lo que se representa es un objeto JavaScript que proporciona datos específicos para esta representación en particular. Por lo general, este tipo de objetos son, de tipo POJO (plain-old-JavaScript-objects), a menudo son documentos de una colección, aunque pueden ser más complejos e incluir funciones.</p>
            </div>
          </div>
        </div>
        <div class="post">
          <div class="top-nav">
            <div class="post-nav">
              <a class="prev" href="http://es.discovermeteor.com/chapters/reactivity/" title="Previous Post: Reactividad">
                «
                Reactividad
              </a>
              <a class="next" href="http://es.discovermeteor.com/chapters/latency-compensation/" title="next Post: Compensación de la latencia">
                Compensación de la latencia
                »
              </a>
            </div>
          </div>
          <div class="post-content">
            <div class="chapter-heading">
              <h2 class="chapter-title">Creando publicaciones</h2>
              <span class="chapter-number">7</span>
            </div>
            <input id="paragraphs" type="hidden" value="60">
            <div class="chapter-summary note chapter">
			  <a href="#men" style="position:fixed;bottom:0px;left:0px;margin:2px;padding:2px 7px;background-color:rgba(64, 64, 64, 0.2);border-radius:50%;box-shadow:0px 0px 5px rgba(0, 0, 0, 0.4);">▲</a>
              <h3 id="men">En este capítulo:</h3>
              <ul>
				  <li><a href="#men-clpde">Creando la página de envío.</a></li>
				  <li><a href="#men-aueelc">Añadiendo un enlace en la cabecera.</a></li>
				  <li><a href="#men-cp">Creando publicaciones.</a></li>
				  <li><a href="#men-aads">Añadiendo algo de seguridad.</a></li>
				  <li><a href="#men-pim">Permitir insertar mensajes.</a></li>
				  <li><a href="#men-aeaaf">Asegurar el acceso al formulario.</a></li>
				  <li><a href="#men-oee">Ocultando el enlace.</a></li>
				  <li><a href="#men-mmpmlsyla">Meteor.methods para mejorar la seguridad y la abstracción.</a></li>
				  <li><a href="#men-ed">Evitando duplicidades.</a></li>
				  <li><a href="#men-olp">Ordenando las publicaciones.</a></li>
			  </ul>
            </div>
            
			<p>Debemos mejorar la inserción de nuevas publicaciones.</p>
            
            <p>Para ello construiremos una interfaz gráfica.</p>
            
            <h3 id="men-clpde">Creando la página de envío</h3>
            
            <p>Define una nueva ruta para el formulario de creación de publicaciones:</p>
			
			<pre><span class="line">Router.configure({</span><span class="line">  <span class="na">layoutTemplate</span>  : <span class="s1">"diseño"</span>,</span><span class="line">  <span class="na">waitOn</span>          : <span class="kd">function</span>(){ <span class="kd">return</span> Meteor.subscribe(<span class="s1">"publicaciones"</span>); },</span><span class="line">  <span class="na">loadingTemplate</span> : <span class="s1">"cargando"</span>,</span><span class="line">  <span class="na">notFoundTemplate</span>: <span class="s1">"noEncontrado"</span></span><span class="line">});</span>
<span class="line">Router.route(<span class="s1">"/"</span>,      {<span class="na">name</span>: <span class="s1">"publicacionesLista"</span>});</span><span class="line added">Router.route(<span class="s1">"/nueva"</span>, {<span class="na">name</span>: <span class="s1">"publicacionesNueva"</span>});</span>
<span class="line">Router.route(<span class="s1">"/publicacion/</span><span class="ss">:_id</span><span class="s1">"</span>, {</span><span class="line">  <span class="na">name</span>: <span class="s1">"publicacionesPagina"</span>,</span><span class="line">  <span class="na">data</span>: <span class="kd">function</span>(){ <span class="kd">return</span> Publicaciones.findOne(<span class="kd">this</span>.params.<span class="ss">_id</span>); }</span><span class="line">});</span>
<span class="line">Router.onBeforeAction(<span class="s1">"dataNotFound"</span>, {<span class="na">only</span>: <span class="s1">"publicacionesPagina"</span>});</span></pre>
            <div class="caption">/lib/router.js</div>
            
            <div class="lines-highlight" data-lines="15" data-class="added"></div>
            
            <h3 id="men-aueelc">Añadiendo un enlace en la cabecera</h3>
            
            <p>Tenemos un enlace para el formulario, ahora añadiremos el botón para ir al formulario:</p>
            
			<pre><span class="line"><span class="nt">&lt;template</span> <span class="na">name</span>=<span class="s1">"cabecera"</span><span class="nt">&gt;</span></span><span class="line">  <span class="nt">&lt;nav</span> <span class="na">class</span>=<span class="s1">"navbar navbar-default"</span> <span class="na">role</span>=<span class="s1">"navegacion"</span><span class="nt">&gt;</span></span><span class="line">    <span class="nt">&lt;div</span> <span class="na">class</span>=<span class="s1">"navbar-header"</span><span class="nt">&gt;</span></span><span class="line">      <span class="nt">&lt;button</span> <span class="na">type</span>=<span class="s1">"button"</span> <span class="na">class</span>=<span class="s1">"navbar-toggle collapsed"</span> <span class="na">data-toggle</span>=<span class="s1">"collapse"</span> <span class="na">data-target</span>=<span class="s1">"#navegacion"</span><span class="nt">&gt;</span></span><span class="line">        <span class="nt">&lt;span</span> <span class="na">class</span>=<span class="s1">"sr-only"</span><span class="nt">&gt;</span>Cambiar navegación<span class="nt">&lt;/span&gt;</span></span><span class="line">        <span class="nt">&lt;span</span> <span class="na">class</span>=<span class="s1">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span></span><span class="line">        <span class="nt">&lt;span</span> <span class="na">class</span>=<span class="s1">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span></span><span class="line">        <span class="nt">&lt;span</span> <span class="na">class</span>=<span class="s1">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span></span><span class="line">      <span class="nt">&lt;/button&gt;</span></span><span class="line">      <span class="nt">&lt;a</span> <span class="na">class</span>=<span class="s1">"navbar-brand"</span> <span class="na">href</span>=<span class="s1">"{{pathFor 'publicacionesLista'}}"</span><span class="nt">&gt;</span>Microscopio<span class="nt">&lt;/a&gt;</span></span><span class="line">    <span class="nt">&lt;/div&gt;</span></span><span class="line">    <span class="nt">&lt;div</span> <span class="na">class</span>=<span class="s1">"collapse navbar-collapse"</span> <span class="na">id</span>=<span class="s1">"navegacion"</span><span class="nt">&gt;</span></span><span class="line added">      <span class="nt">&lt;ul</span> <span class="na">class</span>=<span class="s1">"nav navbar-nav"</span><span class="nt">&gt;</span></span><span class="line added">        <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href</span>=<span class="s1">"{{pathFor 'publicacionesNueva'}}"</span><span class="nt added">&gt;</span>Nueva Publicación<span class="nt">&lt;/a&gt;&lt;/li&gt;</span></span><span class="line added">      <span class="nt">&lt;/ul&gt;</span></span><span class="line">      <span class="nt">&lt;ul</span> <span class="na">class</span>=<span class="s1">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span></span><span class="line">        {{> loginButtons}}</span><span class="line">      <span class="nt">&lt;/ul&gt;</span></span><span class="line">    <span class="nt">&lt;/div&gt;</span></span><span class="line">  <span class="nt">&lt;/nav&gt;</span></span><span class="line"><span class="nt">&lt;/template&gt;</span></span></pre>
            <div class="caption">/client/plantillas/aplicacion/cabecera.html</div>
            
            <div class="lines-highlight" data-lines="13~15" data-class="added"></div>
            
            <p>Ya solo resta que cuando se navege a <code>/nueva</code> se muestre la plantilla <code>publicacionesNueva</code>:</p>
            
			<pre><span class="line"><span class="nt">&lt;template</span> <span class="na">name</span>=<span class="s1">"publicacionesNueva"</span><span class="nt">&gt;</span></span><span class="line">  <span class="nt">&lt;form</span> <span class="na">class</span>=<span class="s1">"main form pagina"</span><span class="nt">&gt;</span></span><span class="line">    <span class="nt">&lt;div</span> <span class="na">class</span>=<span class="s1">"form-group"</span><span class="nt">&gt;</span></span><span class="line">      <span class="nt">&lt;label</span> <span class="na">class</span>=<span class="s1">"control-label"</span> <span class="na">for</span>=<span class="s1">"url"</span><span class="nt">&gt;</span>URL<span class="nt">&lt;/label&gt;</span></span><span class="line">      <span class="nt">&lt;div</span> <span class="na">class</span>=<span class="s1">"controls"</span><span class="nt">&gt;</span></span><span class="line">        <span class="nt">&lt;input</span> <span class="na">name</span>=<span class="s1">"url"</span> <span class="na">id</span>=<span class="s1">"url"</span> <span class="na">type</span>=<span class="s1">"text"</span> <span class="na">value</span>=<span class="s1">""</span> <span class="na">placeholder</span>=<span class="s1">"Dirección web"</span> <span class="na">class</span>=<span class="s1">"form-control"</span><span class="nt">/&gt;</span></span><span class="line">      <span class="nt">&lt;/div&gt;</span></span><span class="line">    <span class="nt">&lt;/div&gt;</span></span><span class="line">    <span class="nt">&lt;div</span> <span class="na">class</span>=<span class="s1">"form-group"</span><span class="nt">&gt;</span></span><span class="line">      <span class="nt">&lt;label</span> <span class="na">class</span>=<span class="s1">"control-label"</span> <span class="na">for</span>=<span class="s1">"titulo"</span><span class="nt">&gt;</span>Título<span class="nt">&lt;/label&gt;</span></span><span class="line">      <span class="nt">&lt;div</span> <span class="na">class</span>=<span class="s1">"controls"</span><span class="nt">&gt;</span></span><span class="line">        <span class="nt">&lt;input</span> <span class="na">name</span>=<span class="s1">"titulo"</span> <span class="na">id</span>=<span class="s1">"titulo"</span> <span class="na">type</span>=<span class="s1">"text"</span> <span class="na">value</span>=<span class="s1">""</span> <span class="na">placeholder</span>=<span class="s1">"Título de su publicación"</span> <span class="na">class</span>=<span class="s1">"form-control"</span><span class="nt">/&gt;</span></span><span class="line">      <span class="nt">&lt;/div&gt;</span></span><span class="line">    <span class="nt">&lt;/div&gt;</span></span><span class="line">    <span class="nt">&lt;input</span> <span class="na">type</span>=<span class="s1">"submit"</span> <span class="na">value</span>=<span class="s1">"Enviar"</span> <span class="na">class</span>=<span class="s1">"btn btn-primary"</span><span class="nt">&gt;</span></span><span class="line">  <span class="nt">&lt;/form&gt;</span></span><span class="line"><span class="nt">&lt;/template&gt;</span></span></pre>
            <div class="caption">/client/plantillas/publicaciones/publicaciones_nueva.html</div>
            
            <p>Ya tenemos nuestro formulario creado y con su propia página:</p>
            
			<figure class="screenshot "><img src="./Creando posts_files/7-1.png" alt="El formulario de creación de publicaciones."><figcaption>El formulario de creación de publicaciones.</figcaption></figure>
            
            <h3 id="men-cp">Creando publicaciones</h3>
            
            <p>Vamos a crear un evento <code>submit</code> y no <code>click</code> para cubrir todas las formas de envío.</p>
            
			<pre><span class="line">Template.publicacionesNueva.events({</span><span class="line">  <span class="s1">"submit form"</span>: <span class="kd">function</span>(<span class="ss">e</span>){</span><span class="line">    <span class="ss">e</span>.preventDefault();</span>
<span class="line">    <span class="kd">var</span> publicacionForm = {</span><span class="line">      <span class="s1">"titulo"</span>: $(<span class="ss">e</span>.target).find(<span class="s1">"[name=titulo]"</span>).val(),</span><span class="line">      <span class="s1">"url"</span>   : $(<span class="ss">e</span>.target).find(<span class="s1">"[name=url]"</span>).val()</span><span class="line">    };</span>
<span class="line">    publicacionForm._id = Publicaciones.insert(publicacionForm);</span><span class="line">    Router.go(<span class="s1">"publicacionesPagina"</span>, publicacionForm);</span><span class="line">  }</span><span class="line">});</span></pre>
            <div class="caption">/client/plantillas/publicaciones/publicaciones_nueva.js</div>
            
            <p>Usamos <a href="http://www.jquery.com/" target="_blank">jQuery</a> y evitamos la recarga de página con <code>preventDefault</code>.</p>
            
			<p>Hemos completado nuestro formulario para insertar nuevas publicaciones sin depender de la consola del navegador web.</p>
            
            <h3 id="men-aads">Añadiendo algo de seguridad</h3>
            
            <p>Debemos evitar que los usuarios no registrados inserten nuevas publicaciones.</p>
			
			<p>Aunque quitemos el formulario de la vista el usuario es posible insertar publicaciones mediante la consola del navegador.</p>
            
            <p>Meteor, por defecto, viene con una seguridad desactivada para poder empezar rapidamente.</p>
            
            <p>Es el momento de eliminar el paquete <code>insecure</code>:</p>
			
			<pre><span class="line"><span class="kd browser-prompt">></span> <span class="kd">meteor</span> remove insecure</span></pre>
			<div class="caption">Terminal</div>
            
            <p>El formulario para crear nuevos mensajes ya no funciona debido a que el paquete <code>insecure</code> no se permiten inserciones en el lado del cliente.</p>
            
            <p>Se deben poner reglas de inserción para los clientes y ejecutar las inserciones en el lado del servidor.</p>
            
            <h3 id="men-pim">Permitir insertar mensajes</h3>
            
            <p>De momento lo pondremos todo a funcionar de nuevo, de una forma sencilla: en <code>/lib/colecciones/publicaciones.js</code>:</p>
			
			<pre><span class="line">Publicaciones = <span class="kd">new</span> Mongo.Collection(<span class="s1">"publicaciones"</span>);</span>
<span class="line added">Publicaciones.allow({</span><span class="line added">  <span class="na">insert</span>: <span class="kd">function</span>(<span class="ss">userId</span>, <span class="ss">doc</span>){</span><span class="line added c1">    // Solo permite publicar si has iniciado sesión.</span><span class="line added">    <span class="kd">return</span> !! <span class="ss">userId</span>;</span><span class="line added">  }</span><span class="line added">});</span></pre>
			<div class="caption">/lib/colecciones/publicaciones.js</div>
			
            <div class="lines-highlight" data-lines="3~8" data-class="added"></div>
            
			<p>En este caso, estamos diciendo: “a los clientes se les permite insertar publicaciones siempre y cuando tengan un <code>userId</code>”.</p>
            
            <p>El <code>userId</code> devuelve <code>null</code> si no hay ningún usuario conectado.</p>
            
            <p>Prueba a crear una publicación sin que haya ningún usuario que haya iniciado sesión:</p>
            
            <figure class="screenshot "><img src="./Creando posts_files/7-2.png" alt="Error en la inserción: Acceso denegado."><figcaption>Error en la inserción: Acceso denegado.</figcaption></figure>
            
            <p>Faltan pulir unas cuantas cosas:</p>
            
            <ul>
				<li>Los <em>usuario no registrados</em> no deben ver el formulario.</li>
				<li>La nueva publicación ha de <em>vincularse</em> al usuario.</li>
				<li>Evitar las publicaciones <em>duplicadas</em>.</li>
            </ul>
            
            <h3 id="men-aeaaf">Asegurar el acceso al formulario</h3>
            
            <p>Evitaremos que los usuarios no registrados puedan acceder al formulario de creación de publicaciones mediante un (<em>hook</em>) en el router.</p>
            
			<p>Será como nuestro guardia de acceso a rutas.</p>
            
            <p>Si un usuario no registrado intenta acceder al formulatio le mostraremos la plantilla <code>accesoDenegado</code> en lugar de la plantilla <code>publicacionesNueva</code>.</p>
            
			<pre><span class="line c1">// •••</span>
<span class="line">Router.route(<span class="s1">"/publicacion/</span><span class="ss">:_id</span><span class="s1">"</span>, {</span><span class="line">  <span class="na">name</span>: <span class="s1">"publicacionesPagina"</span>,</span><span class="line">  <span class="na">data</span>: <span class="kd">function</span>(){ <span class="kd">return</span> Publicaciones.findOne(<span class="kd">this</span>.params.<span class="ss">_id</span>); }</span><span class="line">});</span>
<span class="line added"><span class="kd">var</span> necesarioSesion = <span class="kd">function(){</span></span><span class="line added">  <span class="kd">if</span>( <span class="kd">!</span> Meteor.user() ){</span><span class="line added">    <span class="kd">this</span>.render(<span class="s1">"accesoDenegado"</span>);</span><span class="line added">  } <span class="kd">else</span> {</span><span class="line added">    <span class="kd">this</span>.next();</span><span class="line added">  }</span><span class="line added">}</span>
<span class="line">Router.onBeforeAction(<span class="s1">"dataNotFound"</span>,  {<span class="na">only</span>: <span class="s1">"publicacionesPagina"</span>});</span><span class="line added">Router.onBeforeAction(necesarioSesion, {<span class="na">only</span>: <span class="s1">"publicacionesNueva"</span>});</span></pre>
            <div class="caption">/lib/router.js</div>
            
            <p>El router está configurado, solo resta crear la plantilla de error:</p>
			
			<pre><span class="line"><span class="nt">&lt;template</span> <span class="na">name</span>=<span class="s1">"accesoDenegado"</span><span class="nt">&gt;</span></span><span class="line">  <span class="nt">&lt;div</span> <span class="na">class</span>=<span class="s1">"access-denied pagina jumbotron"</span><span class="nt">&gt;</span></span><span class="line">    <span class="nt">&lt;h2&gt;</span>Acceso Denegado<span class="nt">&lt;/h2&gt;</span></span><span class="line">    <span class="nt">&lt;p&gt;</span>Necesitas <span class="nt">&lt;span</span> <span class="na">class</span>=<span class="s1">"negrita"</span><span class="nt">&gt;</span>iniciar sesión<span class="nt">&lt;/span&gt;</span> para poder ver esta página web.<span class="nt">&lt;/p&gt;</span></span><span class="line nt">  &lt;/div&gt;</span><span class="line"><span class="nt">&lt;/template&gt;</span></span></pre>
            <div class="caption">client/plantillas/extras/acceso_denegado.html</div>
            
            <p>Dirigete a <a href="http://localhost:3000/nueva" target="_blank">http://localhost:3000/nueva</a> sin estar registrados, veremos el mensaje de error:</p>
            
			<figure class="screenshot "><img src="./Creando posts_files/7-3.png" alt="Plantilla de error de acceso"><figcaption>Plantilla de error de acceso</figcaption></figure>
            
            <p>Iniciemos sesión, Meteor mostrará la plantilla <code>accesoDenegado</code> y en cuanto el usuario establezca la conexión con el servidor mostrará la plantilla correcta.</p>
            
            <p>Mostraremos una plantilla de espera en el instante en el que el servidor comprueba si tiene acceso o no.</p>
			
			<p>NOTA: <em>Dependiendo de la versión este paso no será necesario pero igualmente lo mostraremos por si fuese necesario. Para los que ya les sale la plantilla <code>cargando</code> pueden seguir los pasos si quieren</em>.</p>
            
            <p>Así que vamos a modificar nuestra acción para añadir la plantilla de espera mientras <code>Meteor.loggingIn()</code> sea verdadero:</p>
            
			<pre><span class="line c1">// •••</span>
<span class="line"><span class="kd">var</span> necesarioSesion = <span class="kd">function</span>(){</span><span class="line">  <span class="kd">if</span>( <span class="kd">!</span> Meteor.user() ){</span><span class="line added">    <span class="kd">if</span>( Meteor.loggingIn() ){</span><span class="line added">      <span class="kd">this</span>.render(<span class="kd">this</span>.loadingTemplate);</span><span class="line added">    } <span class="kd">else</span> {</span><span class="line added">      <span class="kd">this</span>.render(<span class="s1">"accesoDenegado"</span>);</span><span class="line added">    }</span><span class="line">  } <span class="kd">else</span> {</span><span class="line">    <span class="kd">this</span>.next();</span><span class="line">  }</span><span class="line">}</span>
<span class="line">Router.onBeforeAction(<span class="s1">"dataNotFound"</span>,  {<span class="na">only</span>: <span class="s1">"publicacionesPagina"</span>});</span><span class="line">Router.onBeforeAction(necesarioSesion, {<span class="na">only</span>: <span class="s1">"publicacionesNueva"</span>});</span></pre>
            <div class="caption">/lib/router.js</div>
            
            <div class="lines-highlight" data-lines="5~9" data-class="added"></div>
            
            <h3 id="men-oee">Ocultando el enlace</h3>
            
            <p>Podemos ocultar facilmente el enlace al formulario:</p>
            
			<pre><span class="line c1">// •••</span>
<span class="line"><span class="nt">&lt;ul</span> <span class="na">class</span>=<span class="s1">"nav navbar-nav"</span><span class="nt">&gt;</span></span><span class="line added">  {{#if currentUser}}<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href</span>=<span class="s1">"{{pathFor 'publicacionesNueva'}}"</span><span class="nt">&gt;</span>Nueva Publicación<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>{{/if}}</span><span class="line nt">&lt;/ul&gt;</span>
<span class="line c1">// •••</span></pre>
            <div class="caption">/client/plantillas/aplicacion/cabecera.html</div>
            
            <div class="lines-highlight" data-lines="3~5" data-class="added"></div>
            
            <p>El ayudante <code>currentUser</code> es el equivalente a <code>Meteor.user()</code>	.</p>
            
            <h3 id="men-mmpmlsyla">Meteor.methods para mejorar la seguridad y la abstracción</h3>
            
            <p>Todavía quedan cosas que debemos mejorar:</p>
            
            <ul>
				<li>Añadir la <a href="https://www.es.wikipedia.org/wiki/Marca_temporal">Marca temporal</a> a las publicaciones.</li>
				<li>No duplicar direcciones web.</li>
				<li>Añadir detalles del autor a la publicación.</li>
            </ul>
            
            <p>Podríamos tener un montón de problemas si lo programamos en el controlador <code>submit</code>.</p>
            
            <ul>
				<li>La <em>marca temporal</em> no puede confiar en la hora del usuario.</li>
				<li>Los clientes no conocerán <code>todas</code> las URL publicadas..</li>
				<li>Añadir los datos del cliente en los mensajes pueden generar ataque por consola desde el lado del cliente.</li>
            </ul>
            
            <p>Para solventar estos problemas debemos usar <strong>métodos</strong>.</p>
            
            <p>Volvamos a <code>publicaciones_nueva.js</code>. En lugar de insertar directamente en la colección <code>Publicaciones</code>, vamos a llamar a un método llamado <code>publicacionesInsertar</code>:</p>
            
			<pre><span class="line">Template.publicacionesNueva.events({</span><span class="line">  <span class="s1">"submit form"</span>: <span class="kd">function</span>(<span class="ss">e</span>){</span><span class="line">    <span class="ss">e</span>.preventDefault();</span>
<span class="line">    <span class="kd">var</span> publicacionForm = {</span><span class="line">      <span class="na">titulo</span>: $(<span class="ss">e</span>.target).find(<span class="s1">"[name=titulo]"</span>).val(),</span><span class="line">      <span class="na">url</span>   : $(<span class="ss">e</span>.target).find(<span class="s1">"[name=url]"</span>).val()</span><span class="line">    };</span>
<span class="line added">    Meteor.call(<span class="s1">"publicacionesInsertar"</span>, publicacionForm, <span class="kd">function</span>(<span class="ss">error</span>, <span class="ss">resultado</span>){</span><span class="line c1 added">      // Mostrar el error al usuario y abortar</span><span class="line added">      <span class="kd">if</span>( <span class="ss">error</span> ){</span><span class="line added">        <span class="kd">return</span> alert(<span class="ss">error</span>.reason);</span>
<span class="line added">      } <span class="kd">else if</span>( <span class="ss">resultado</span>.error == <span class="s1">"datosErroneos"</span> ){</span><span class="line added">        <span class="kd">return</span> alert(<span class="s1">"Error: El tipo de datos es incorrecto."</span>);</span><span class="line added">      }</span>
<span class="line added">      Router.go(<span class="s1">"publicacionesPagina"</span>, {<span class="na">_id</span>: <span class="ss">resultado</span>._id});</span><span class="line added">    });</span><span class="line">  }</span><span class="line">});</span></pre>
			<div class="caption">/client/plantillas/publicaciones/publicaciones_nueva.js</div>
            
            <p>La función <code>Meteor.call</code> llama a una función del servidor llamada <code class="s1">"publicacionesInsertar"</code> que luego crearemos, le pasaremos a esa función el objeto <code>publicacionForm</code> como parámetro..</p>
            
			<p>Después de ejecutar la función <code class="s1">"publicacionesInsertar"</code> en el servidor se ejecutará la función del <code>Meteor.call</code> que tiene los parámetros <code>(<span class="ss">error</span>, <span class="ss">resultado</span>)</code>.</p>
			
			<p>Si hay algún error se mostrará con <code>error.reason</code></p>
			
			<h3 id="men-cds">Comprobaciones de seguridad</h3>
            
            <p>Vamos a definir el método <code>publicacionesInsertar</code> en nuestro fichero <code>/colecciones/publicaciones.js</code>y eliminaremos el bloque <code>allow()</code>.</p>
            
			<pre><span class="line">Publicaciones = <span class="kd">new</span> Mongo.Collection(<span class="s1">"publicaciones"</span>);</span>
<span class="line added">Meteor.methods({</span><span class="line added">  <span class="s1">"publicacionesInsertar"</span>: <span class="kd">function</span>(<span class="ss">nuevaPublicacion</span>){</span><span class="line added c1">    // Comprobar los datos.</span><span class="line added">    <span class="kd">if</span>(  <span class="kd">typeof</span> <span class="ss">nuevaPublicacion</span>.url    != <span class="s1">"string"</span></span><span class="line added">      || <span class="kd">typeof</span> <span class="ss">nuevaPublicacion</span>.titulo != <span class="s1">"string"</span></span><span class="line added">      || <span class="kd">typeof</span> Meteor.userId()         != <span class="s1">"string"</span></span><span class="line added">    ){</span><span class="line added">      <span class="kd">return</span> {<span class="na">error</span>: <span class="s1">"datosErroneos"</span>}</span><span class="line added">    }</span>
<span class="line added c1">    // Añadir los datos del usuario actual: Meteor.user()</span><span class="line added">    <span class="kd">var</span> usuarioActual = Meteor.user();</span><span class="line added">    nuevaPublicacion._usuario = {</span><span class="line added">      <span class="na">_id</span>   : usuarioActual._id,</span><span class="line added">      <span class="na">autor</span> : usuarioActual.username</span><span class="line added">    };</span><span class="line added">    nuevaPublicacion.fecha = {<span class="na">insercion</span>: <span class="kd">new</span> <span class="nb">Date</span>()};</span>
<span class="line added c1">    // Inserción de la publicación nueva a la vez que devuelve el id de la publicación creada.</span><span class="line added">    <span class="kd">return</span> {<span class="na">_id</span>: Publicaciones.insert(<span class="ss">nuevaPublicacion</span>)};</span><span class="line added">  }</span><span class="line added">});</span></pre>
            <div class="caption">/lib/colecciones/publicaciones.js</div>
            
            <div class="lines-highlight" data-lines="3~24" data-class="added"></div>
            
			<h3 id="men-ed">Evitando duplicidades</h3>
            
            <p>Comprovaremos si esa dirección web existe y si es así dirigiremos al usuario a la página de la publicación existente.</p>
            
			<pre><span class="line">Publicaciones = <span class="kd">new</span> Mongo.Collection(<span class="s1">"publicaciones"</span>);</span>
<span class="line">Meteor.methods({</span><span class="line">  <span class="s1">"publicacionesInsertar"</span>: <span class="kd">function</span>(<span class="ss">nuevaPublicacion</span>){</span><span class="line c1">    // Comprobar los datos.</span><span class="line">    <span class="kd">if</span>(  <span class="kd">typeof</span> <span class="ss">nuevaPublicacion</span>.url    != <span class="s1">"string"</span></span><span class="line">      || <span class="kd">typeof</span> <span class="ss">nuevaPublicacion</span>.titulo != <span class="s1">"string"</span></span><span class="line">      || <span class="kd">typeof</span> Meteor.userId()         != <span class="s1">"string"</span></span><span class="line">    ){</span><span class="line">      <span class="kd">return</span> {<span class="na">error</span>: <span class="s1">"datosErroneos"</span>}</span><span class="line">    }</span>
<span class="line added c1">    // Comprobar si existe la dirección web</span><span class="line added">    <span class="kd">if</span>( Publicaciones.findOne({<span class="s1">"url"</span>: <span class="ss">nuevaPublicacion</span>.url}) ){</span><span class="line added">      <span class="kd">return</span> {</span><span class="line added">        <span class="na">error</span>: <span class="s1">"publicacionExistente"</span>,</span><span class="line added">        <span class="na">_id</span>  : Publicaciones.findOne({<span class="s1">"url"</span>: <span class="ss">nuevaPublicacion</span>.url})._id</span><span class="line added">      };</span><span class="line added">    }</span>
<span class="line c1">    // Añadir los datos del usuario actual: Meteor.user()</span><span class="line">    <span class="kd">var</span> usuarioActual = Meteor.user();</span><span class="line">    nuevaPublicacion._usuario = {</span><span class="line">      <span class="na">_id</span>  : usuarioActual._id,</span><span class="line">      <span class="na">autor</span>: usuarioActual.username</span><span class="line">    };</span><span class="line">    nuevaPublicacion.fecha = {<span class="na">insercion</span>: <span class="kd">new</span> <span class="nb">Date</span>()};</span>
<span class="line c1">    // Inserción de la publicación nueva a la vez que devuelve el id de la publicación creada.</span><span class="line">    <span class="kd">return</span> {<span class="na">_id</span>: Publicaciones.insert(<span class="ss">nuevaPublicacion</span>)};</span><span class="line">  }</span><span class="line">});</span></pre>
            <div class="caption">/lib/colecciones/publicaciones.js</div>
            
            <p>Si la URL que nos han pasado existe en la base de datos, <code>Publicaciones.findOne()</code>, devolvemos el <code>_id</code >de la publicación (<code>nuevaPublicacion</code>) y el error producido para que <code>Meteor.call()</code> lo reciba.</p>
            
            <p>Si <code>Publicaciones.findOne()</code> nos devuelve <code><span class="nb">undefined</span></code> significa que la URL no existe.</p>
			
			<p>Dirijamonos al ayudante de <code>publicaciones_nueva.js</code> para decirle que hará cuando <code>Meteor.call</code> encuentre <code><span class="s1">"publicacionExistente"</span></code>:</p>
			
			<pre><span class="line">Template.publicacionesNueva.events({</span><span class="line">  <span class="s1">"submit form"</span>: <span class="kd">function</span>(<span class="ss">e</span>){</span><span class="line">    <span class="ss">e</span>.preventDefault();</span>
<span class="line">    <span class="kd">var</span> publicacionForm = {</span><span class="line">      <span class="na">titulo</span> : $(<span class="ss">e</span>.target).find(<span class="s1">"[name=titulo]"</span>).val(),</span><span class="line">      <span class="na">url</span>    : $(<span class="ss">e</span>.target).find(<span class="s1">"[name=url]"</span>).val()</span><span class="line">    };</span>
<span class="line">    Meteor.call(<span class="s1">"publicacionesInsertar"</span>, publicacionForm, <span class="kd">function</span>(<span class="ss">error</span>, <span class="ss">resultado</span>){</span><span class="line c1">      // Mostrar el error al usuario y abortar</span><span class="line">      <span class="kd">if</span>( <span class="ss">error</span> ){</span><span class="line">        <span class="kd">return</span> alert(<span class="ss">error</span>.reason);</span>
<span class="line">      } <span class="kd">else if</span>( <span class="ss">resultado</span>.error == <span class="s1">"datosErroneos"</span> ){</span><span class="line">        <span class="kd">return</span> alert(<span class="s1">"Error: El tipo de datos es incorrecto."</span>);</span>
<span class="line added c1">      // Mostrar el error al usuario y redirigir a la publicación existente</span><span class="line added">      } <span class="kd">else if</span>( <span class="ss">resultado</span>.error == <span class="s1">"publicacionExistente"</span> ){</span><span class="line added">        alert(<span class="s1">"Error: Ya existe una publicación con esta dirección web."</span>);</span><span class="line added">      }</span>
<span class="line">      Router.go(<span class="s1">"publicacionesPagina"</span>, {<span class="na">_id</span>: <span class="ss">resultado</span>._id});</span><span class="line">    });</span><span class="line">  }</span><span class="line">});</span></pre>
            <div class="caption">/client/plantillas/publicaciones/publicaciones_nueva.js</div>
            
			<h3 id="men-olp">Ordenando las publicaciones</h3>
            
            <p>Se ha añadido una fecha de creación a nuestras publicaciones y las ordenaremos usando el operador <code>sort</code> de Mongo</p>
			
			<pre><span class="line">Template.publicacionesLista.helpers({</span><span class="line">  <span class="na">publicaciones: <span class="kd">function</span>(){</span></span><span class="line added">    <span class="kd">return</span> Publicaciones.find({}, {<span class="na">sort</span>: {<span class="s1">"fecha.insercion"</span>: <span class="nb">-1</span>}});</span><span class="line">  }</span><span class="line">});</span></pre>
            <div class="caption">/client/plantillas/publicaciones/publicaciones_lista.js</div>
            
            <p>Ahora solo los usuarios pueden insertar publicaciones.</p>
            
			<p>Vamos a iniciar sesión y a crear nuestra primera publicación.</p>
			
			<p>Una vez creada, debería dirigirnos a la página de la nueva publicación.</p>
			
			<figure class="screenshot "><img src="./Creando posts_files/7-4.png" alt="Publicación creada por el formulario."><figcaption>Publicación creada por el formulario</figcaption></figure>
            
            <p>Para editar o borrar publicaciones lo veremos en el siguiente capítulo.</p>
          </div>
          <div class="bottom-nav">
            <div class="post-nav">
              <a class="prev" href="http://es.discovermeteor.com/chapters/reactivity/" title="Previous Post: Reactividad">
                «
                Reactividad
              </a>
              <a class="next" href="http://es.discovermeteor.com/chapters/latency-compensation/" title="next Post: Compensación de la latencia">
                Compensación de la latencia
                »
              </a>
            </div>
          </div>
        </div>
        <div class="comments sidebar">
          <a class="sidebar-toggle" data-disqus-identifier="creating-posts_es" href="http://es.discovermeteor.com/chapters/creating-posts/#disqus_thread">5 Comments</a>
          <div class="sidebar-inner">
            <div class="issues">
              <a class="issue-link simple-button" href="https://github.com/DiscoverMeteor/Microscope/issues" target="_blank">Reporta un problema con el código</a>
              <a class="issue-link simple-button" href="https://github.com/DiscoverMeteor/DiscoverMeteor_es/issues" target="_blank">Reporta un problema con el libro</a>
              <hr>
              <p>O, comenta el contenido aquí:</p>
            </div>
            <div id="disqus_thread"><iframe id="dsq-app1644" name="dsq-app1644" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Creando posts_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 1309px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'discovermeteores'; // required: replace example with your forum shortname
                var disqus_identifier = 'creating-posts_es';
            
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function () {
                var s = document.createElement('script'); s.async = true;
                s.type = 'text/javascript';
                s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
                }());
            
            </script>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <div class="row">
        © 2014 <a href="http://tom.thesnail.org/">Tom Coleman</a> y <a href="http://sachagreif.com/">Sacha Greif</a>
      </div>
    </footer>
    <!-- %script{:src => "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"} -->
    <script src="./Creando posts_files/moment.min.js.descarga"></script>
    <script src="./Creando posts_files/es.js.descarga"></script>
    <script src="./Creando posts_files/script.js.descarga"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-38246482-5', 'discovermeteor.com');
      ga('send', 'pageview');
    </script>
    <input id="lang" type="hidden" value="es">
  

<iframe style="display: none;" src="./Creando posts_files/saved_resource(1).html"></iframe></body></html>